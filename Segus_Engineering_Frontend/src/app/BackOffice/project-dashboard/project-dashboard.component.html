<div class="project-dashboard">
  <!-- Header simplifi√© -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1>üìä Dashboard Projets</h1>
      <button class="btn-primary" (click)="openCreateProjectModal()">
        ‚ûï Nouveau Projet
      </button>
    </div>

    <!-- Stats simplifi√©es -->
    <div class="stats-grid">
      <div class="stat-item">
        <span class="stat-number">{{ projects.length }}</span>
        <span class="stat-label">Projets</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ tasks.length }}</span>
        <span class="stat-label">T√¢ches</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ subtasks.length }}</span>
        <span class="stat-label">Sous-t√¢ches</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">{{ activeProjects }}</span>
        <span class="stat-label">Actifs</span>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading">
    <div class="spinner"></div>
    <p>Chargement...</p>
  </div>

  <!-- Contenu principal -->
  <div class="main-content" *ngIf="!isLoading">

    <!-- Section gauche: Filtres et liste des projets -->
    <div class="left-panel">

      <!-- Filtres -->
      <div class="filters-section">
        <div class="filter-group">
        <input
          type="text"
          [(ngModel)]="projectFilters.search"
          (keyup.enter)="loadProjects()"
            placeholder="üîç Rechercher un projet..."
          class="search-input"
        >
      </div>
        <div class="filter-group">
          <select [(ngModel)]="projectFilters.status" (change)="loadProjects()" class="status-filter">
            <option value="">üìã Tous les statuts</option>
              <option *ngFor="let status of Object.keys(ProjectStatus)" [value]="status">
                {{ getStatusLabel(status) }}
              </option>
            </select>
        </div>
      </div>

      <!-- Liste des projets -->
      <div class="projects-list">
        <h3>üìÅ Projets ({{ projects.length }})</h3>
        <div class="project-cards">
        <div
            *ngFor="let project of projects"
          class="project-card"
            [class.active]="selectedProject?.id === project.id"
          (click)="selectProject(project)"
        >
          <div class="project-header">
            <h4>{{ project.title }}</h4>
              <span class="status-badge" [class]="'status-' + project.status.toLowerCase()">
              {{ getStatusLabel(project.status) }}
            </span>
            </div>
            <p class="project-description">{{ project.description | slice:0:80 }}{{ project.description.length > 80 ? '...' : '' }}</p>
          <div class="project-meta">
              <span class="date">{{ project.start_date | date:'dd/MM' }} - {{ project.end_date | date:'dd/MM' }}</span>
              <span class="progress">{{ project.progress_percentage }}%</span>
          </div>
          <div class="project-actions">
            <button class="btn-icon" (click)="openEditProjectModal(project); $event.stopPropagation()" title="Modifier">
              ‚úèÔ∏è
            </button>
            <button class="btn-icon" (click)="confirmDeleteProject(project.id); $event.stopPropagation()" title="Supprimer">
              üóëÔ∏è
            </button>
          </div>
        </div>
      </div>
    </div>
    </div>

    <!-- Section droite: D√©tails du projet s√©lectionn√© -->
    <div class="right-panel">
      <div *ngIf="!selectedProject" class="no-selection">
        <div class="empty-state">
          <h3>üëà S√©lectionnez un projet</h3>
          <p>Choisissez un projet dans la liste pour voir ses d√©tails et g√©rer ses t√¢ches</p>
        </div>
      </div>

      <div *ngIf="selectedProject" class="project-details">
        <!-- En-t√™te du projet -->
        <div class="project-header-detail">
          <div class="project-title-section">
          <h2>{{ selectedProject.title }}</h2>
            <span class="status-badge large" [class]="'status-' + selectedProject.status.toLowerCase()">
            {{ getStatusLabel(selectedProject.status) }}
          </span>
        </div>
          <div class="project-actions-header">
            <button class="btn-secondary" (click)="openEditProjectModal(selectedProject)">
              ‚úèÔ∏è Modifier
            </button>
            <button class="btn-secondary" (click)="openAssignEmployeesModal(selectedProject)">
              üë• Assigner Employ√©s
            </button>
            <button class="btn-danger" (click)="confirmDeleteProject(selectedProject.id)">
              üóëÔ∏è Supprimer
            </button>
          </div>
        </div>

        <!-- Informations du projet -->
        <div class="project-info">
          <div class="info-grid">
            <div class="info-item">
              <label>Description</label>
              <p>{{ selectedProject.description }}</p>
            </div>
            <div class="info-item">
              <label>P√©riode</label>
              <p>{{ selectedProject.start_date | date:'dd/MM/yyyy' }} - {{ selectedProject.end_date | date:'dd/MM/yyyy' }}</p>
            </div>
            <div class="info-item">
              <label>Progression</label>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="selectedProject.progress_percentage"></div>
              </div>
              <span class="progress-text">{{ selectedProject.progress_percentage }}%</span>
            </div>
            <div class="info-item">
              <label>Employ√©s assign√©s</label>
              <div class="assigned-employees">
                <span *ngFor="let emp of selectedProject.assigned_employees" class="employee-tag">
                  {{ emp.full_name || emp.first_name + ' ' + emp.last_name }}
                </span>
                <span *ngIf="selectedProject.assigned_employees.length === 0" class="no-employees">
                  Aucun employ√© assign√©
                </span>
              </div>
          </div>
          </div>
        </div>

        <!-- Section des t√¢ches -->
        <div class="tasks-section">
          <div class="tasks-header">
            <h3>üìã T√¢ches ({{ selectedProject ? selectedProject.tasks.length : 0 }})</h3>
            <button class="btn-primary small" (click)="openCreateTaskModal()">
              ‚ûï Nouvelle T√¢che
            </button>
          </div>

          <!-- Formulaire nouvelle t√¢che -->
          <div *ngIf="isCreatingTask" class="task-form">
            <h4>Nouvelle T√¢che</h4>
            <form (ngSubmit)="submitCreateTask()" #taskForm="ngForm">
              <div class="form-row">
                <input
                  type="text"
                  [(ngModel)]="newTask.title"
                  name="taskTitle"
                  placeholder="Titre de la t√¢che"
                  required
                  class="form-input"
                >
                <select [(ngModel)]="newTask.priority" name="taskPriority" class="form-select">
                  <option value="MEDIUM">Priorit√© moyenne</option>
                  <option value="LOW">Priorit√© basse</option>
                  <option value="HIGH">Priorit√© haute</option>
                  <option value="VERY_HIGH">Priorit√© tr√®s haute</option>
                </select>
              </div>
                <textarea
                  [(ngModel)]="newTask.description"
                  name="taskDescription"
                placeholder="Description de la t√¢che"
                  rows="3"
                class="form-textarea"
                ></textarea>
              <div class="form-row">
                  <input
                    type="date"
                    [(ngModel)]="newTask.start_date"
                    name="taskStartDate"
                  class="form-input"
                >
                  <input
                    type="date"
                    [(ngModel)]="newTask.end_date"
                    name="taskEndDate"
                  class="form-input"
                >
              </div>
              <div class="form-actions">
                <button type="submit" [disabled]="taskForm.invalid || isCreatingTaskInProgress" class="btn-primary">
                  {{ isCreatingTaskInProgress ? 'Cr√©ation...' : 'Cr√©er' }}
                </button>
                <button type="button" (click)="cancelCreateTask()" class="btn-secondary">
                  Annuler
                </button>
              </div>
            </form>
          </div>

          <!-- Liste des t√¢ches -->
          <div class="tasks-list">
            <div *ngFor="let task of selectedProject.tasks" class="task-card">
              <div class="task-header">
                <h4>{{ task.title }}</h4>
                <div class="task-badges">
                  <span class="priority-badge" [class]="'priority-' + task.priority.toLowerCase()">
                    {{ getPriorityLabel(task.priority) }}
                  </span>
                  <span class="status-badge" [class]="'status-' + task.status.toLowerCase()">
                    {{ getStatusLabel(task.status) }}
                </span>
                </div>
              </div>
              <p class="task-description">{{ task.description }}</p>
              <div class="task-meta">
                <span class="date">{{ task.start_date | date:'dd/MM' }} - {{ task.end_date | date:'dd/MM' }}</span>
                <span class="progress">{{ task.progress_percentage }}%</span>
              </div>
              <div class="task-actions">
                <button class="btn-icon" (click)="openEditTaskModal(task)" title="Modifier">
                  ‚úèÔ∏è
                </button>
                <button class="btn-icon" (click)="confirmDeleteTask(task.id)" title="Supprimer">
                  üóëÔ∏è
                </button>
                <button class="btn-icon" (click)="openCreateSubtaskModal(task.id)" title="Ajouter sous-t√¢che">
                  ‚ûï
                </button>
              </div>

              <!-- Formulaire de cr√©ation de sous-t√¢che -->
              <div *ngIf="isCreatingSubtask[task.id]" class="subtask-form">
                <h5>Nouvelle Sous-t√¢che</h5>
                <form (ngSubmit)="submitCreateSubtask(task.id)" #subtaskForm="ngForm">
                  <div class="form-row">
                    <input
                      type="text"
                      [(ngModel)]="newSubtask.section_name"
                      name="sectionName"
                      placeholder="Nom de la section"
                      required
                      class="form-input"
                    >
                    <input
                      type="text"
                      [(ngModel)]="newSubtask.section_number"
                      name="sectionNumber"
                      placeholder="Num√©ro de section"
                      required
                      class="form-input"
                    >
                  </div>
                  <div class="form-row">
                    <input
                      type="text"
                      [(ngModel)]="newSubtask.section_id"
                      name="sectionId"
                      placeholder="ID de section"
                      required
                      class="form-input"
                    >
                    <input
                      type="number"
                      [(ngModel)]="newSubtask.kilometrage"
                      name="kilometrage"
                      placeholder="Kilom√©trage"
                      required
                      class="form-input"
                    >
                  </div>
                  <div class="form-actions">
                    <button type="submit" class="btn-primary" [disabled]="subtaskForm.invalid || isCreatingSubtaskInProgress">
                      {{ isCreatingSubtaskInProgress ? 'Cr√©ation...' : 'Cr√©er' }}
                    </button>
                    <button type="button" (click)="cancelCreateSubtask(task.id)" class="btn-secondary">
                      Annuler
                    </button>
                  </div>
                </form>
              </div>

              <!-- Liste des sous-t√¢ches -->
              <div *ngIf="task.subtasks && task.subtasks.length > 0" class="subtasks-list">
                <h6>Sous-t√¢ches:</h6>
                <div *ngFor="let subtask of task.subtasks" class="subtask-item">
                  <div class="subtask-info">
                    <strong>{{ subtask.section_name }}</strong> - {{ subtask.section_number }}
                    <span class="subtask-meta">ID: {{ subtask.section_id }} | {{ subtask.kilometrage }}km</span>
                  </div>
                  <div class="subtask-actions">
                    <button class="btn-icon" (click)="openEditSubtaskModal(subtask)" title="Modifier">‚úèÔ∏è</button>
                    <button class="btn-icon" (click)="confirmDeleteSubtask(subtask.id)" title="Supprimer">üóëÔ∏è</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour cr√©er/modifier un projet -->
  <div *ngIf="isCreatingProject || isEditingProject" class="modal-overlay" (click)="closeProjectModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ isCreatingProject ? 'Nouveau Projet' : 'Modifier le Projet' }}</h3>
        <button class="btn-close" (click)="closeProjectModal()">√ó</button>
      </div>
      <form (ngSubmit)="submitProjectForm()" #projectForm="ngForm">
        <div class="form-group">
          <label>Titre du projet</label>
          <input
            type="text"
            [(ngModel)]="currentProjectData.title"
            name="projectTitle"
            required
            class="form-input"
          >
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea
            [(ngModel)]="currentProjectData.description"
            name="projectDescription"
            rows="3"
            required
            class="form-textarea"
          ></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Date de d√©but</label>
            <input
              type="date"
              [(ngModel)]="currentProjectData.start_date"
              name="projectStartDate"
              required
              class="form-input"
            >
          </div>
          <div class="form-group">
            <label>Date de fin</label>
            <input
              type="date"
              [(ngModel)]="currentProjectData.end_date"
              name="projectEndDate"
              required
              class="form-input"
            >
          </div>
        </div>
        <div class="form-group">
          <label>Statut</label>
          <select [(ngModel)]="currentProjectData.status" name="projectStatus" required class="form-select">
            <option value="">S√©lectionner un statut</option>
            <option *ngFor="let status of Object.keys(ProjectStatus)" [value]="status">
              {{ getStatusLabel(status) }}
            </option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="submit" [disabled]="projectForm.invalid || isSubmittingProject" class="btn-primary">
            {{ isSubmittingProject ? 'Traitement...' : (isCreatingProject ? 'Cr√©er' : 'Modifier') }}
          </button>
          <button type="button" (click)="closeProjectModal()" class="btn-secondary">
            Annuler
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal pour assigner des employ√©s -->
  <div *ngIf="isAssigningEmployees" class="modal-overlay" (click)="closeAssignEmployeesModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Assigner des Employ√©s</h3>
        <button class="btn-close" (click)="closeAssignEmployeesModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p>S√©lectionnez les employ√©s √† assigner au projet :</p>
        <div class="employee-list">
          <div *ngFor="let employee of employees" class="employee-item">
            <label>
              <input type="checkbox"
                     [checked]="selectedEmployeeIds.includes(employee.id)"
                     (change)="toggleEmployeeSelection(employee.id)">
              {{ employee.full_name || employee.first_name + ' ' + employee.last_name }}
            </label>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" (click)="closeAssignEmployeesModal()" class="btn-secondary">
            Annuler
          </button>
          <button type="button" (click)="submitAssignEmployees()" [disabled]="isAssigningEmployeesInProgress" class="btn-primary">
            {{ isAssigningEmployeesInProgress ? 'Assignation...' : 'Assigner' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmation de suppression -->
  <div *ngIf="showConfirmModal" class="modal-overlay" (click)="cancelConfirmation()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Confirmation</h3>
        <button class="btn-close" (click)="cancelConfirmation()">√ó</button>
      </div>
      <div class="modal-body">
        <p>{{ confirmModalMessage }}</p>
        <div class="modal-actions">
          <button type="button" (click)="cancelConfirmation()" class="btn-secondary">
            Annuler
          </button>
          <button type="button" (click)="executeConfirmation()" class="btn-danger">
            Confirmer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts pour les notifications -->
  <div class="toast-container">
    <div *ngFor="let toast of toasts"
         class="toast"
         [class]="'toast-' + toast.type"
         (click)="dismissToast(toast.id)">
      {{ toast.message }}
    </div>
  </div>
</div>
