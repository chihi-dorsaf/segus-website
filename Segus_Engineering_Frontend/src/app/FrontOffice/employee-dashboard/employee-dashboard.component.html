<div class="dashboard-container">
  <!-- En-tête avec chronomètre -->
  <div class="dashboard-header">
    <div class="welcome-section">
      <h1 class="welcome-title">
        Bonjour, {{ dashboardData?.employee_info?.name || 'Employé' }} !
      </h1>
      <p class="welcome-subtitle">
        {{ dashboardData?.employee_info?.position }}
      </p>
    </div>

    <!-- Chronomètre de travail -->
    <div class="work-timer-section">
      <div class="timer-display">
        <div class="timer-label">Temps de travail</div>
        <div class="timer-value">{{ sessionTimer }}</div>
        <button class="btn btn-sm btn-outline-light" (click)="refreshSession()" title="Rafraîchir">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>

      <!-- Affichage des pauses -->
      <div class="pause-display" *ngIf="currentSession">
        <div class="pause-item">
          <span class="pause-label">Pause en cours</span>
          <span class="pause-value">{{ pauseTimer }}</span>
        </div>
        <div class="pause-item">
          <span class="pause-label">Total pauses</span>
          <span class="pause-value">{{ totalPause }}</span>
        </div>
      </div>

      <div class="timer-controls">
        <ng-container *ngIf="!currentSession">
          <button class="btn btn-success btn-lg" (click)="startWorkSession()">
            <i class="fas fa-play"></i> Démarrer
          </button>
        </ng-container>

        <ng-container *ngIf="currentSession?.status === 'active'">
          <button class="btn btn-warning btn-lg me-2" (click)="pauseWorkSession()">
            <i class="fas fa-pause"></i> Pause
          </button>
          <button class="btn btn-danger btn-lg" (click)="endWorkSession()">
            <i class="fas fa-stop"></i> Terminer
          </button>
        </ng-container>

        <ng-container *ngIf="currentSession?.status === 'paused'">
          <button class="btn btn-success btn-lg me-2" (click)="resumeWorkSession()">
            <i class="fas fa-play"></i> Reprendre
          </button>
          <button class="btn btn-danger btn-lg" (click)="endWorkSession()">
            <i class="fas fa-stop"></i> Terminer
          </button>
        </ng-container>
      </div>
    </div>
  </div>

  <!-- Statistiques principales -->
  <div class="stats-grid" *ngIf="dashboardData">
    <div class="stat-card">
      <div class="stat-icon projects-icon">
        <i class="fas fa-project-diagram"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ dashboardData?.projects_overview?.total || 0 }}</div>
        <div class="stat-label">Projets assignés</div>
        <div class="stat-details">
          <span class="badge bg-success">{{ dashboardData?.projects_overview?.active || 0 }} actifs</span>
          <span class="badge bg-warning">{{ dashboardData?.projects_overview?.completed || 0 }} terminés</span>
          <span class="badge bg-danger" *ngIf="dashboardData?.projects_overview?.overdue > 0">
            {{ dashboardData?.projects_overview?.overdue }} en retard
          </span>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon tasks-icon">
        <i class="fas fa-tasks"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ dashboardData?.tasks_overview?.total || 0 }}</div>
        <div class="stat-label">Tâches assignées</div>
        <div class="stat-details">
          <span class="badge bg-secondary">{{ dashboardData?.tasks_overview?.todo || 0 }} à faire</span>
          <span class="badge bg-warning">{{ dashboardData?.tasks_overview?.in_progress || 0 }} en cours</span>
          <span class="badge bg-success">{{ dashboardData?.tasks_overview?.completed || 0 }} terminées</span>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon performance-icon">
        <i class="fas fa-chart-line"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ dashboardData?.performance?.percentage || 0 }}%</div>
        <div class="stat-label">Performance</div>
        <div class="stat-details">
          <span class="badge" [ngClass]="'bg-' + getPerformanceColor(dashboardData?.performance?.percentage || 0)">
            {{ dashboardData?.performance?.level || 'N/A' }}
          </span>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon subtasks-icon">
        <i class="fas fa-list-ul"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ dashboardData?.subtasks_overview?.total || 0 }}</div>
        <div class="stat-label">Sous-tâches assignées</div>
        <div class="stat-details">
          <span class="badge bg-success">{{ dashboardData?.subtasks_overview?.completed || 0 }} terminées</span>
          <span class="badge bg-warning">{{ dashboardData?.subtasks_overview?.pending || 0 }} en cours</span>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon urgent-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ dashboardData.urgent_tasks?.length || 0 }}</div>
        <div class="stat-label">Tâches urgentes</div>
        <div class="stat-details">
          <span class="badge bg-danger" *ngIf="dashboardData.urgent_tasks?.length > 0">
            {{ dashboardData.urgent_tasks?.length }} prioritaires
          </span>
          <span class="badge bg-success" *ngIf="!dashboardData.urgent_tasks?.length">
            Aucune urgence
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Actions rapides -->
  <div class="quick-actions-section" *ngIf="dashboardData">
    <div class="quick-actions-grid">
      <button class="quick-action-btn" (click)="navigateToTasks()">
        <i class="fas fa-tasks"></i>
        <span>Mes Tâches</span>
        <div class="action-badge">{{ dashboardData?.tasks_overview?.total || 0 }}</div>
      </button>
      
      <button class="quick-action-btn" (click)="navigateToProjects()">
        <i class="fas fa-project-diagram"></i>
        <span>Mes Projets</span>
        <div class="action-badge">{{ dashboardData?.projects_overview?.active || 0 }}</div>
      </button>
      
      <button class="quick-action-btn" (click)="navigateToCalendar()">
        <i class="fas fa-calendar-alt"></i>
        <span>Planning</span>
        <div class="action-badge bg-info">Aujourd'hui</div>
      </button>
      
      <button class="quick-action-btn" (click)="navigateToReports()">
        <i class="fas fa-chart-bar"></i>
        <span>Rapports</span>
        <div class="action-badge bg-success">{{ dashboardData?.performance?.percentage || 0 }}%</div>
      </button>
    </div>
  </div>

  <!-- Sections des projets, tâches et sous-tâches -->
  <div class="dashboard-sections" *ngIf="dashboardData">
    <!-- Projets récents -->
    <div class="section-card">
      <div class="section-header">
        <h3 class="section-title">
          <i class="fas fa-project-diagram"></i>
          Projets récents
        </h3>
        <div class="section-actions">
          <button class="btn btn-outline-primary btn-sm" (click)="navigateToProjects()">
            <i class="fas fa-external-link-alt"></i>
            Voir tout
          </button>
        </div>
      </div>

      <div class="projects-list" *ngIf="dashboardData?.recent_projects?.length; else noProjects">
        <div class="project-item" *ngFor="let project of dashboardData?.recent_projects || []">
          <div class="project-header">
            <h4 class="project-name">{{ project.name }}</h4>
            <span class="project-status" [ngClass]="'bg-' + getStatusColor(project.status)">
              {{ project.status }}
            </span>
          </div>

          <div class="project-details">
            <span><i class="fas fa-calendar"></i> {{ formatDate(project.deadline) }}</span>
            <span><i class="fas fa-percentage"></i> {{ project.progress }}%</span>
          </div>

          <div class="project-progress">
            <div class="progress-bar">
              <div class="progress-fill"
                   [ngClass]="'bg-' + getProgressColor(project.progress)"
                   [style.width.%]="project.progress">
              </div>
            </div>
          </div>
        </div>
      </div>

      <ng-template #noProjects>
        <div class="no-projects">
          <p>Aucun projet récent</p>
        </div>
      </ng-template>
    </div>

    <!-- Tâches urgentes -->
    <div class="section-card">
      <div class="section-header">
        <h3 class="section-title">
          <i class="fas fa-exclamation-triangle"></i>
          Tâches urgentes
        </h3>
        <div class="section-actions">
          <button class="btn btn-outline-danger btn-sm" (click)="navigateToTasks()">
            <i class="fas fa-th-large"></i>
            Kanban
          </button>
          <button class="btn btn-outline-primary btn-sm" (click)="navigateToTasks()">
            <i class="fas fa-external-link-alt"></i>
            Voir tout
          </button>
        </div>
      </div>

      <div class="urgent-tasks-list" *ngIf="dashboardData?.urgent_tasks?.length; else noUrgentTasks">
        <div class="task-item" *ngFor="let task of dashboardData?.urgent_tasks || []">
          <div class="task-header">
            <h4 class="task-name">{{ task.title }}</h4>
            <span class="task-status" [ngClass]="'bg-' + getPriorityColor(task.priority)">
              {{ task.priority }}
            </span>
          </div>

          <div class="task-details">
            <span><i class="fas fa-project-diagram"></i> {{ task.project_name }}</span>
            <span><i class="fas fa-calendar"></i> {{ formatDate(task.deadline) }}</span>
          </div>

          <div class="task-progress">
            <div class="progress-bar">
              <div class="progress-fill"
                   [ngClass]="'bg-' + getProgressColor(task.progress)"
                   [style.width.%]="task.progress">
              </div>
            </div>
          </div>
          
          <div class="task-actions">
            <button class="btn-task-action" (click)="markTaskComplete(task.id)" title="Marquer comme terminé">
              <i class="fas fa-check"></i>
            </button>
            <button class="btn-task-action" (click)="editTask(task.id)" title="Modifier">
              <i class="fas fa-edit"></i>
            </button>
          </div>
        </div>
      </div>

      <ng-template #noUrgentTasks>
        <div class="no-urgent-tasks">
          <p>Aucune tâche urgente</p>
        </div>
      </ng-template>
    </div>

    <!-- Sous-tâches récentes -->
    <div class="section-card" *ngIf="dashboardData?.subtasks_overview?.total > 0">
      <div class="section-header">
        <h3 class="section-title">
          <i class="fas fa-list-ul"></i>
          Mes sous-tâches
        </h3>
        <div class="section-actions">
          <button class="btn btn-outline-primary btn-sm" (click)="navigateToTasks()">
            <i class="fas fa-external-link-alt"></i>
            Voir toutes
          </button>
        </div>
      </div>

      <div class="subtasks-summary">
        <div class="summary-item">
          <div class="summary-number">{{ dashboardData?.subtasks_overview?.total || 0 }}</div>
          <div class="summary-label">Total assignées</div>
        </div>
        <div class="summary-item">
          <div class="summary-number text-success">{{ dashboardData?.subtasks_overview?.completed || 0 }}</div>
          <div class="summary-label">Terminées</div>
        </div>
        <div class="summary-item">
          <div class="summary-number text-warning">{{ dashboardData?.subtasks_overview?.pending || 0 }}</div>
          <div class="summary-label">En cours</div>
        </div>
        <div class="summary-item">
          <div class="summary-number text-info">
            {{ dashboardData?.subtasks_overview?.total > 0 ? 
               ((dashboardData?.subtasks_overview?.completed / dashboardData?.subtasks_overview?.total) * 100 | number:'1.0-0') : 0 }}%
          </div>
          <div class="summary-label">Progression</div>
        </div>
      </div>

      <div class="subtasks-progress" *ngIf="dashboardData?.subtasks_overview?.total > 0">
        <div class="progress-bar">
          <div class="progress-fill bg-success"
               [style.width.%]="dashboardData?.subtasks_overview?.total > 0 ? 
                                 (dashboardData?.subtasks_overview?.completed / dashboardData?.subtasks_overview?.total) * 100 : 0">
          </div>
        </div>
        <div class="progress-text">
          {{ dashboardData?.subtasks_overview?.completed || 0 }} / {{ dashboardData?.subtasks_overview?.total || 0 }} sous-tâches terminées
        </div>
      </div>
    </div>
  </div>

  <!-- Activité récente -->
  <div class="section-card" *ngIf="dashboardData && dashboardData.recent_activity?.length">
    <h3 class="section-title">
      <i class="fas fa-history"></i>
      Activité récente
    </h3>

    <div class="recent-activity">
      <div class="activity-item" *ngFor="let activity of dashboardData?.recent_activity || []">
        <div class="activity-icon">
          <i class="fas" [ngClass]="getActivityIcon(activity.type)"></i>
        </div>
        <div class="activity-content">
          <div class="activity-title">{{ activity.title }}</div>
          <div class="activity-details">{{ activity.description }}</div>
          <div class="activity-project">{{ activity.project_name }}</div>
          <div class="activity-time">{{ formatDate(activity.timestamp) }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- États de chargement et erreurs -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="loading-spinner"></div>
    <p>Chargement en cours...</p>
  </div>

  <div class="error-message" *ngIf="error">
    <i class="fas fa-exclamation-circle"></i>
    {{ error }}
  </div>
</div>
